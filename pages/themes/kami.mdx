# Kami ä¸»é¢˜

import { ToGitHub } from '@components/ToGitHub';

<ToGitHub repo="mx-space/kami" />

import { Callout, Steps } from "nextra/components";


> ä¸‹ä¸€ä¸ªä»£æ›¿é¡¹ç›®å°†ä¼šæ˜¯ Shiroï¼Œå½“å®ƒå®Œæˆä¹‹æ—¶ï¼Œæˆ‘ä¾¿ä¸å†æŠ•å…¥ä»»ä½•ç²¾åŠ›åˆ° Kami ä¸­ã€‚è¿æ¥æœªæ¥æ€»éœ€è¦èˆå¼ƒä¸€äº›ä¸œè¥¿ï¼Œéå¸¸æ„Ÿè°¢å¤§å®¶ä¸‰å¹´æ¥ä½¿ç”¨ Kamiï¼Œä¸ç®¡ä½ æ˜¯è°ï¼Œéƒ½éœ€è¦å¯¹ä½ è¯´å£°è°¢è°¢ã€‚**â€”â€” Innei**



<Callout type="warning">
ç”±äº Kami ä¸»é¢˜å°†ä¸å†ç»´æŠ¤ï¼Œè¯¥éƒ¨åˆ†æ–‡æ¡£å°†ä¼šä¿æŒæœ€å°ç¨‹åº¦çš„æ›´æ–°ï¼›å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä½¿ç”¨ Kami è¦æ±‚æœåŠ¡å™¨çš„ Linux å†…æ ¸ç‰ˆæœ¬ä¸å°äº 4.19ã€‚
</Callout>


<Steps>
### æ£€æŸ¥å†…æ ¸ç‰ˆæœ¬

```bash
uname -r
```
å¦‚æœä½ çš„å†…æ ¸ç‰ˆæœ¬å°äº 4.19ï¼Œè¯·å‡çº§å†…æ ¸ã€‚æˆ–è€…ä½¿ç”¨æœ€æ–°çš„ Ubuntu / Debian ã€‚


### å…‹éš†é¡¹ç›®

```bash
git clone https://github.com/mx-space/kami.git --depth=1
cd kami && git fetch --tags && git checkout $(git rev-list --tags --max-count=1)
```

### å®‰è£…ä¾èµ–

```bash
git lfs fetch --all
git lfs pull
pnpm i
```

### é…ç½® ENV

1. å¤åˆ¶ .env.example ä¸º .env
2. ç¼–è¾‘ .env æ–‡ä»¶ï¼Œå®ƒçœ‹èµ·æ¥åº”è¯¥æ˜¯è¿™ä¸ªæ ·å­çš„

```env
# API åœ°å€
NEXT_PUBLIC_API_URL=https://server.test.cn/api/v2
# GATEWAY åœ°å€
NEXT_PUBLIC_GATEWAY_URL=https://server.test.cn
#å‰ç«¯ä½¿ç”¨çš„é…ç½®é¡¹åå­—
NEXT_PUBLIC_SNIPPET_NAME=kami
# å¦‚æœä½¿ç”¨ CDN, ä¿®æ”¹äº§ç‰©å‰ç¼€ï¼›ä¸€èˆ¬ç•™ç©º
ASSETPREFIX=
```

### å¼€å§‹æ„å»º

```bash
pnpm build
```

### å¯åŠ¨å‰ç«¯

```bash
pnpm prod:pm2
```

### åå‘ä»£ç†

ä»¥ä¸‹é…ç½®æ–‡ä»¶ä»¥ Nginx ä¸ºä¾‹ï¼Œè‹¥ä½¿ç”¨ Caddy è¿›è¡Œé…ç½®å¯å‚è€ƒ [Caddyfile æ–‡ä»¶ç¤ºä¾‹](https://github.com/mx-space/docker/blob/master/Caddyfile.example)è¿›è¡Œç›¸åº”ä¿®æ”¹ã€‚

```nginx
server {
    ## åå‘ä»£ç†å¼€å§‹ 
    ## WebSocket åœ°å€
    location /socket.io {
        proxy_set_header Upgrade $http_upgrade; 
        proxy_set_header Connection "Upgrade"; 
        proxy_buffering off; 
        proxy_set_header Host $host; 
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        proxy_set_header X-Forwarded-Proto $scheme; 
        proxy_pass http://127.0.0.1:2333/socket.io; 
    }
    ## API åœ°å€
    location /api/v2 {
        proxy_pass http://127.0.0.1:2333/api/v2; 
    }
    ## ç®€è¯» render åœ°å€
    location /render {
        proxy_pass http://127.0.0.1:2333/render; 
    }
    ## Kami åœ°å€
    location / {
        proxy_pass http://127.0.0.1:2323; 
    }
    ## åå°åœ°å€
    location /qaqdmin {
        proxy_pass http://127.0.0.1:2333/qaqdmin;
    }
    ## æœ¬åœ°åå°åœ°å€
    location /proxy {
        proxy_pass http://127.0.0.1:2333/proxy;
    }
    ## RSS åœ°å€
    location ~* \/(feed|sitemap|atom.xml) {
        proxy_pass http://127.0.0.1:2333/$1; 
    }
    ## åå‘ä»£ç†ç»“æŸ
}
``` 

å®Œæ•´ç¤ºä¾‹å¦‚ä¸‹

```nginx
server {
    listen 80;
    listen 443 ssl http2 ; 
    ## ç»‘å®šåŸŸå 
    server_name www.example.com; 
    index index.html; 
    proxy_set_header Host $host; 
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
    proxy_set_header X-Forwarded-Host $server_name; 
    proxy_set_header Upgrade $http_upgrade; 
    proxy_set_header Connection "upgrade"; 
    error_log /www/sites/www.example.com/log/error.log;
    access_log /www/sites/www.example.com/log/access.log; 
    location /socket.io {
        proxy_set_header Upgrade $http_upgrade; 
        proxy_set_header Connection "Upgrade"; 
        proxy_set_header Host $host; 
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; 
        proxy_set_header X-Forwarded-Proto $scheme; 
        proxy_pass http://127.0.0.1:2333/socket.io; 
    }
    location /api/v2 {
        proxy_pass http://127.0.0.1:2333/api/v2; 
    }
    location /render {
        proxy_pass http://127.0.0.1:2333/render; 
    }
    location / {
        proxy_pass http://127.0.0.1:2323; 
    }
    location /qaqdmin {
        proxy_pass http://127.0.0.1:2333/qaqdmin;
    }
    location /proxy {
        proxy_pass http://127.0.0.1:2333/proxy;
    }
    location ~* \/(feed|sitemap|atom.xml) {
        proxy_pass http://127.0.0.1:2333/$1; 
    }
    ssl_certificate /www/sites/www.example.com/ssl/fullchain.pem; 
    ssl_certificate_key /www/sites/www.example.com/ssl/privkey.pem; 
    ssl_protocols TLSv1.3 TLSv1.2 TLSv1.1 TLSv1; 
    ssl_ciphers 'ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA:ECDHE-ECDSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!3DES:!MD5:!PSK'; 
    ssl_prefer_server_ciphers on; 
    ssl_session_cache shared:SSL:10m; 
    ssl_session_timeout 10m; 
    error_page 497 https://$host$request_uri; 
    limit_conn perserver 300; 
    limit_conn perip 25; 
    limit_rate 512k; 
}
```
### å®Œæˆ

<Callout type="info">
å¦‚æœæ‚¨æŒ‰ç…§æ–‡æ¡£ç¤ºä¾‹é…ç½® Nginx åå‘ä»£ç†ï¼Œæ‚¨è¦æ—¶åˆ»è®°ä½ï¼Œæ‚¨çš„ï¼š
- API åœ°å€ä¸º `https://www.example.com/api/v2`
- Kami åœ°å€ä¸º `https://www.example.com` 
- GateWay ä¸º `https://www.example.com`
- åå°ä¸º `https://www.example.com/qaqdmin`
- æœ¬åœ°åå°ä¸º `https://www.example.com/proxy/qaqdmin`
</Callout>

</Steps>

## æ›´æ–°

åˆ†ä¸ºå¯¹ Kami è¿›è¡Œé­”æ”¹å’Œæœªé­”æ”¹ä¸¤ç§æƒ…å†µã€‚

### æœªé­”æ”¹

<Callout emoji="ğŸ’¡">
è¯¥æ–¹æ³•é€‚åˆäºå¯¹ Kami æºä»£ç æ²¡æœ‰åšæ”¹åŠ¨çš„ç”¨æˆ·ã€‚
</Callout>

ç›´æ¥åœ¨ `kami` æ–‡ä»¶å¤¹ä¸‹æ‰§è¡Œ `git pull origin master`ï¼š

```bash
cd ~/mx-space/kami
git pull origin master
```

å®‰è£…ä¾èµ–ã€æ„å»ºã€å¯åŠ¨å‰ç«¯ï¼š

```bash
pnpm i
pnpm build
pm2 start
```

<Callout type="warning" emoji="âš ï¸">
ä½ åº”è¯¥ç†è§£çš„æ˜¯ï¼Œå³ä¾¿æ˜¯ä½ æ²¡æœ‰å¯¹ Kami è¿›è¡Œä»»ä½•é­”æ”¹ï¼Œä»æœ‰å¯èƒ½å‡ºç°ä»£ç ä¸èƒ½è‡ªåŠ¨åˆå¹¶çš„é—®é¢˜ï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œå»ºè®®å‚è€ƒä¸‹é¢çš„å·²é­”æ”¹éƒ¨åˆ†å®Œæˆå‡çº§ã€‚
</Callout>

### å·²é­”æ”¹

<Callout emoji="ğŸ’¡">
æ­¤æ–¹æ³•é€‚ç”¨äºå¯¹å‰ç«¯é­”æ”¹åçš„å‡çº§ï¼Œæˆ‘ä»¬è®¤ä¸ºä½ ä¿®æ”¹äº† 'kami/src' é‡Œé¢çš„æºä»£ç ï¼Œè¿™æ ·çš„è¯ï¼Œå®¹æ˜“å‡ºç°åˆå¹¶å†²çªï¼Œå»ºè®®æ‰‹åŠ¨æ›¿æ¢ã€‚
</Callout>

å°† `kami` æ–‡ä»¶å¤¹æ”¹ä¸ºä»»æ„åå­—ï¼Œä¾‹å¦‚ä¿®æ”¹ä¸º `kami.d`ï¼Œç„¶åæ‹‰å– kami å‰ç«¯ä»“åº“ï¼Œæ›´æ–°åˆ°ç¨³å®šç‰ˆæœ¬ï¼š

```bash
cd ~/mx-space
git clone https://github.com/mx-space/kami.git --depth=1
cd kami && git fetch --tags && git checkout $(git rev-list --tags --max-count=1)
```

ç„¶åå°†æ›´æ–°å‰ä¹‹å‰é…ç½®æ—¶ä¿®æ”¹è¿‡çš„æ–‡ä»¶ï¼Œå¦‚åœ¨ `kami.d` ä¸­çš„ `.env` å’Œ `public` æ–‡ä»¶å¤¹å¤åˆ¶åˆ° `kami`ï¼Œå°†ä½ çš„ä¿®æ”¹çš„éƒ¨åˆ†ä¾æ¬¡ä¿®æ”¹æ›¿æ¢å®Œæˆã€‚

å®‰è£…ä¾èµ–ã€æ„å»ºã€å¯åŠ¨å‰ç«¯ï¼š

```bash
pnpm i
pnpm build
pm2 start
```

<style global jsx>{`
 .nextra-content pre {
     max-height: 50vh;
  }
`}</style>
